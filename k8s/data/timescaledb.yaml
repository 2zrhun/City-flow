apiVersion: v1
kind: ConfigMap
metadata:
  name: timescaledb-init
  namespace: cityflow
data:
  001-init.sql: |
    CREATE EXTENSION IF NOT EXISTS timescaledb;
  002-schema.sql: |
    CREATE TABLE IF NOT EXISTS traffic_raw (
      ts          TIMESTAMPTZ NOT NULL,
      sensor_id   TEXT        NOT NULL,
      road_id     TEXT        NOT NULL,
      speed_kmh   DOUBLE PRECISION,
      flow_rate   DOUBLE PRECISION,
      occupancy   DOUBLE PRECISION,
      PRIMARY KEY (ts, sensor_id)
    );

    SELECT create_hypertable('traffic_raw', 'ts', if_not_exists => TRUE);
    CREATE INDEX IF NOT EXISTS idx_traffic_raw_road_ts ON traffic_raw (road_id, ts DESC);

    CREATE TABLE IF NOT EXISTS predictions (
      ts               TIMESTAMPTZ NOT NULL,
      road_id          TEXT        NOT NULL,
      horizon_min      INT         NOT NULL DEFAULT 30,
      congestion_score DOUBLE PRECISION NOT NULL,
      confidence       DOUBLE PRECISION,
      model_version    TEXT        NOT NULL DEFAULT 'baseline-v1',
      PRIMARY KEY (ts, road_id, horizon_min)
    );

    CREATE TABLE IF NOT EXISTS reroutes (
      ts                 TIMESTAMPTZ NOT NULL,
      route_id           TEXT        NOT NULL,
      alt_route_id       TEXT        NOT NULL,
      reason             TEXT        NOT NULL,
      estimated_co2_gain DOUBLE PRECISION,
      eta_gain_min       DOUBLE PRECISION,
      PRIMARY KEY (ts, route_id, alt_route_id)
    );
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: timescaledb-pvc
  namespace: cityflow
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timescaledb
  namespace: cityflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: timescaledb
  template:
    metadata:
      labels:
        app: timescaledb
    spec:
      containers:
        - name: timescaledb
          image: timescale/timescaledb:latest-pg16
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: cityflow-secrets
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: cityflow-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cityflow-secrets
                  key: POSTGRES_PASSWORD
          readinessProbe:
            exec:
              command: ["/bin/sh", "-c", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            exec:
              command: ["/bin/sh", "-c", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
            initialDelaySeconds: 20
            periodSeconds: 15
          volumeMounts:
            - name: timescaledb-data
              mountPath: /var/lib/postgresql/data
            - name: timescaledb-init
              mountPath: /docker-entrypoint-initdb.d
      volumes:
        - name: timescaledb-data
          persistentVolumeClaim:
            claimName: timescaledb-pvc
        - name: timescaledb-init
          configMap:
            name: timescaledb-init
---
apiVersion: v1
kind: Service
metadata:
  name: timescaledb
  namespace: cityflow
spec:
  selector:
    app: timescaledb
  ports:
    - port: 5432
      targetPort: 5432
